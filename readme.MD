# Backend - Api y base de datos
# CONSULTORIOS MÃ‰DICOS UTN
# UTN - TUP | PPS 2025
# Alumno Juan Jose Chaparro

## DescripciÃ³n
El repositorio contiene la parte del backend de un proyecto para las **PPS** de la Tecnicatura Universitaria en ProgramaciÃ³n (UTN FRBB). Esta API, construida con **Node.js** y **Express.js**, proporciona funcionalidades para un Consultorio MÃ©dico: la gestiÃ³n de usuarios, autenticaciÃ³n mediante JWT (JSON Web Tokens), y conexiÃ³n a una base de datos SQLite.

## CaracterÃ­sticas
- **AutenticaciÃ³n de usuarios**: Registro e inicio de sesiÃ³n con JWT y encriptaciÃ³n de contraseÃ±as usando `bcryptjs`.
- **GestiÃ³n de usuarios**: CreaciÃ³n, lectura, actualizaciÃ³n y eliminaciÃ³n de usuarios.
- **ConexiÃ³n a base de datos**: IntegraciÃ³n con `sqlite3` para almacenar datos de usuarios y otras entidades.
- **Endpoints RESTful**: API diseÃ±ada para operaciones CRUD.

## InstalaciÃ³n
Sigue estos pasos para configurar el proyecto localmente:

1. **Clona el repositorio**:
   ```bash
   git clone https://github.com/ChapaStone1/TUP_PPS_API.git
   cd TUP_PPS_API
   ```

2. **Instala las dependencias**:
   ```bash
   npm install express sqlite3 bcrypt cors dotenv jsonwebtoken
   ```

3. **Configura las variables de entorno**:
   Crea un archivo `.env` en la raÃ­z del proyecto con las siguientes variables:
   ```env
   SECRET_KEY=Clave123
   JWT_SECRET=miclavesecreta123
   PORT=3000
   ```

4. **Inicia el servidor**:
   ```bash
   npm run start
   ```

La API estarÃ¡ disponible en `http://localhost:3000`.

## Base de datos

Diagrama entidad-relaciÃ³n:  
![Diagrama ER](doc/diagramaER.png)


# Endpoints

Los endpoints fueron diseÃ±ados en funciÃ³n de las acciones especÃ­ficas que puede realizar cada tipo de usuario. Por ejemplo, el usuario administrador tiene permisos para resetear contraseÃ±as de cualquier usuario o eliminar pacientes, el usuario mÃ©dico puede cargar consultas, listar pacientes, modificar su perfil, y el usuario paciente que puede modificar su perfil y ver su historia clinica.


## ğŸ” AutenticaciÃ³n

### ğŸ“ Registrar paciente

- **MÃ©todo:** `POST`  
- **Ruta:** `/api/auth/register-paciente`

#### ğŸ“¥ Request Body:
```json
{
  "nombre": "Ana",
  "apellido": "GÃ³mez",
  "dni": "12345678",
  "sexo": "femenino",
  "fecha_nac": "1990-05-12",
  "email": "ana@example.com",
  "telefono": "1122334455",
  "password": "claveSegura123",
  "grupo_sanguineo": "O+",
  "obra_social": "OSDE"
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Paciente registrado exitosamente",
  "usuarioId": 6
}
```

---

### ğŸ”“ Login

- **MÃ©todo:** `POST`  
- **Ruta:** `/api/auth/login`

#### ğŸ“¥ Request Body:
```json
{
  "email": "ana@example.com",
  "password": "claveSegura123"
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Login exitoso",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tipo": "paciente"
}
```

---

## ğŸ“Œ Endpoints para Administradores (Todos requieren Token y ser usuario tipo admin)

### â• Crear mÃ©dico

- **MÃ©todo:** `POST`  
- **Ruta:** `/api/medicos/cargar-medico`

#### ğŸ“¥ Request Body:
```json
{
  "nombre": "Laura",
  "apellido": "Sosa",
  "dni": "55667788",
  "sexo": "femenino",
  "fecha_nac": "1985-08-20",
  "telefono": "555667788",
  "email": "laura@example.com",
  "password": "clave123",
  "matricula": "MP67890",
  "consultorio": "202",
  "especialidad_id": 2
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "MÃ©dico creado correctamente",
  "id": 3
}
```

---

### âŒ Eliminar paciente

- **MÃ©todo:** `DELETE`  
- **Ruta:** `/api/medicos/eliminar-paciente/:idpaciente`

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Paciente eliminado correctamente"
}
```

---

### ğŸ” Habilitar/Deshabilitar mÃ©dico (para que el mÃ©dico se muestre disponible en la lista que ven los pacientes)

- **MÃ©todo:** `PATCH`  
- **Ruta:** `/admin/habilitacion-medico/:id`

#### ParÃ¡metro:
- `:id` â†’ ID del mÃ©dico (`usuario_id`)

#### Respuesta:
```json
{
  "status": 200,
  "message": "MÃ©dico habilitado correctamente"
}
```

---

### ğŸ“„ Listar todos los mÃ©dicos

- **MÃ©todo:** `GET`  
- **Ruta:** `/admin/all-medicos`

#### ğŸ“¤ Respuesta:
```json
{
  "status": 200,
  "data": [
    {
      "id": 14,
      "nombre": "Juan",
      "apellido": "PÃ©rez",
      "dni": "12345678",
      "sexo": "M",
      "fecha_nac": "1980-01-01",
      "telefono": "1122334455",
      "email": "juan@example.com",
      "matricula": "MAT123",
      "consultorio": "Consultorio 1",
      "habilitado": 1,
      "especialidad_id": 2,
      "especialidad_nombre": "CardiologÃ­a"
    }
  ]
}
```

---

### ğŸ‘¥ Listar usuarios

- **MÃ©todo:** `GET`  
- **Ruta:** `/admin/all-users?dni=1234&limit=10&offset=0`

#### Query params:
- `dni` â†’ (opcional) filtro parcial por DNI
- `limit` â†’ (opcional) cantidad mÃ¡xima de resultados
- `offset` â†’ (opcional) desde quÃ© Ã­ndice empezar

#### ğŸ“¤ Respuesta:
```json
{
  "status": 200,
  "data": [
    {
      "id": 3,
      "nombre": "Ana",
      "apellido": "GÃ³mez",
      "dni": "12345678",
      "sexo": "F",
      "fecha_nac": "1990-05-10",
      "telefono": "1122448899",
      "email": "ana@gmail.com",
      "tipo": "paciente"
    }
  ]
}
```

---

### ğŸ”„ Resetear contraseÃ±a

- **MÃ©todo:** `PATCH`  
- **Ruta:** `/admin/reset-password/:id`

#### ğŸ“¤ Respuesta:
```json
{
  "status": 200,
  "data": "ContraseÃ±a restablecida para el usuario 3, password: "clave12345678""
}
```

---

## ğŸ“Œ Endpoints para Pacientes

### âœ… Obtener perfil

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/pacientes/mi-perfil` 

#### ğŸ“¤ Respuesta:
```json
{
  "id": 1,
  "nombre": "Ana",
  "apellido": "GÃ³mez",
  "dni": "12345678",
  "sexo": "femenino",
  "fecha_nac": "1990-05-12",
  "telefono": "1122334455",
  "email": "ana@example.com",
  "grupo_sanguineo": "O+",
  "obra_social": "OSDE"
}
```

---

### ğŸ“ Actualizar perfil

- **MÃ©todo:** `PUT`  
- **Ruta:** `/api/pacientes/mi-perfil`

#### ğŸ“¥ Request Body:
```json
{
  "nombre": "Ana",
  "apellido": "GÃ³mez",
  "dni": "12345678",
  "sexo": "femenino",
  "fecha_nac": "1990-05-12",
  "telefono": "1122334455",
  "email": "ana@example.com",
  "password": "nuevaClave123",
  "grupo_sanguineo": "O+",
  "obra_social": "OSDE"
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Perfil actualizado correctamente"
}
```

---

### ğŸ“š Ver historia clÃ­nica

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/pacientes/historia-clinica`

#### ğŸ“¤ Respuesta:
```json
[
  {
    "id": 10,
    "fecha": "2024-05-22",
    "nota": "Chequeo general sin complicaciones",
    "medicacion": "Paracetamol",
    "medico_nombre": "Carlos",
    "medico_apellido": "PÃ©rez",
    "consultorio": "101",
    "especialidad": "ClÃ­nica General"
  }
]
```

---

## âš™ï¸ Endpoints para MÃ©dicos

### âœ… Obtener perfil

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/medicos/mi-perfil`

#### ğŸ“¤ Respuesta:
```json
{
  "id": 2,
  "nombre": "Carlos",
  "apellido": "PÃ©rez",
  "dni": "87654321",
  "sexo": "masculino",
  "fecha_nac": "1980-10-15",
  "telefono": "123456789",
  "email": "carlos@example.com",
  "tipo": "medico",
  "matricula": "MP12345",
  "consultorio": "101",
  "especialidad_id": 3,
  "especialidad": "ClÃ­nica General"
}
```

---

### ğŸ“ Actualizar perfil

- **MÃ©todo:** `PUT`  
- **Ruta:** `/api/medicos/mi-perfil`

#### ğŸ“¥ Request Body:
```json
{
  "nombre": "Carlos",
  "apellido": "PÃ©rez",
  "dni": "87654321",
  "sexo": "masculino",
  "fecha_nac": "1980-10-15",
  "telefono": "123456789",
  "email": "carlos@example.com",
  "password": "nuevaClave123",
  "matricula": "MP12345",
  "consultorio": "101",
  "especialidad_id": 3
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Perfil del mÃ©dico actualizado correctamente"
}
```

---

### ğŸ“‘ Obtener especialidades

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/medicos/especialidades`

#### ğŸ“¤ Respuesta:
```json
[
  { "id": 1, "nombre": "CardiologÃ­a" },
  { "id": 2, "nombre": "NeurologÃ­a" }
]
```

---

### ğŸ‘¨â€âš•ï¸ Ver todos los pacientes

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/medicos/all-pacientes?dni=1234&limit=10&offset=0`

#### ğŸ“¤ Respuesta:
```json
[
  {
    "id": 5,
    "nombre": "LucÃ­a",
    "apellido": "MartÃ­nez",
    "dni": "12341234",
    "sexo": "femenino",
    "fecha_nac": "1995-04-10",
    "telefono": "99887766",
    "email": "lucia@example.com",
    "grupo_sanguineo": "A+",
    "obra_social": "IOMA",
    "historia_clinica": [
      {
        "id": 100,
        "fecha": "2024-06-01",
        "medicacion": "Ibuprofeno",
        "nota": "Dolor de cabeza",
        "medico": {
          "id": 2,
          "nombre": "Carlos",
          "apellido": "PÃ©rez"
        }
      }
    ]
  }
]
```

---

### ğŸ” Buscar paciente por DNI

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/medicos/buscar-paciente/:dni`

#### ğŸ“¤ Respuesta:
```json
{
  "id": 5,
  "nombre": "LucÃ­a",
  "apellido": "MartÃ­nez",
  "dni": "12341234",
  "sexo": "femenino",
  "fecha_nac": "1995-04-10",
  "telefono": "99887766",
  "email": "lucia@example.com",
  "grupo_sanguineo": "A+",
  "obra_social": "IOMA"
}
```

---

### ğŸ©º Cargar consulta mÃ©dica

- **MÃ©todo:** `POST`  
- **Ruta:** `/api/medicos/cargar-consulta/:idpaciente`

#### ğŸ“¥ Request Body:
```json
{
  "nota": "Dolor abdominal agudo",
  "medicacion": "Omeprazol"
}
```

#### ğŸ“¤ Respuesta:
```json
{
  "message": "Consulta agregada correctamente",
  "id": 101
}
```

---

### ğŸ“‹ Ver historia clÃ­nica por ID

- **MÃ©todo:** `GET`  
- **Ruta:** `/api/medicos/historia-clinica/:id`

#### ğŸ“¤ Respuesta:
```json
[
  {
    "id": 100,
    "fecha": "2024-06-01",
    "nota": "Dolor de cabeza",
    "medicacion": "Ibuprofeno",
    "medico_nombre": "Carlos",
    "medico_apellido": "PÃ©rez",
    "consultorio": "101",
    "especialidad": "NeurologÃ­a"
  }
]
```

---

## ğŸ—‚ Estructura del Proyecto
```plaintext
TUP_PPS_API/
â”œâ”€â”€ /controllers/    # LÃ³gica de negocio para los endpoints
â”œâ”€â”€ /routes/         # DefiniciÃ³n de rutas de la API
â”œâ”€â”€ /models/         # Modelos de datos y conexiÃ³n a la base de datos
â”œâ”€â”€ /middleware/     # Middlewares (ej. autenticaciÃ³n con JWT)
â”œâ”€â”€ /db/             # Scripts SQL para la base de datos
â”œâ”€â”€ /validators/     # Validaciones de datos
â”œâ”€â”€ package.json     # Dependencias y scripts del proyecto
â”œâ”€â”€ .env             # Variables de entorno (no incluido en el repositorio)
â””â”€â”€ index.js         # Punto de entrada de la aplicaciÃ³n
```
